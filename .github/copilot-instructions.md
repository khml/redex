# Copilot Instructions - redex

## プロジェクト概要

本リポジトリはRubyで実装する「シンプル言語処理系」を目的とした軽量ライブラリ/ツールの開発リポジトリです。
- 言語: Ruby 3.x 想定
- 主な機能: 空白区切りトークンのパーサ、四則演算、`let`/`const`、ホスト（Ruby）呼び出しフック

ドキュメントと要件は `docs/requirements/requirements_specification.md` にまとめられています。

---

## 開発前の必須確認事項

作業を開始する前に、以下のドキュメントを必ず確認してください。設計方針や前提条件が記載されています。

ドキュメントは `docs/` ディレクトリに格納されています。要件定義は特に以下を参照してください:

- 要件定義: docs/requirements/requirements_specification.md
- レビュー履歴: docs/requirements/review_history.md

開発環境やテスト実行手順は `README.md` と `spec/`（または `test/`）内のファイルを参照してください。

---

## チケット運用ルール

### チケット管理

- 全タスクは `tickets/` ディレクトリにテキストファイルとして管理します。
- ファイル名形式（必須）: `<4桁チケット番号>_<チケット名>.txt`（例: `0001_requirements.txt`, `0002_setup_structure.txt`）
- 親子関係の扱い: チケット間の関係はファイル内に明記してくださいが、ファイル名自体はすべて4桁形式とします（子チケットのための特別な命名形式は使用しません）。

### チケットステータス

- 完了したチケットの扱い:
    - ユーザーがチケット内に完了ステータスを記載する、または
    - ユーザーがファイルを `tickets/done/` ディレクトリに移動する
- 完了状態のチケットは再対応不要です。

---

## 開発規約

プロジェクト固有の簡易ルール:

- コードとドキュメントは日本語で記載（技術用語は英語可）。
 - ライブラリ配置: `lib/redex/` を想定。
- テスト: `spec/` を推奨（RSpec）。最小限のユニットテストを必須とする。
- 重要な設計決定（例: `context`/`ruby_resolver` 挙動、戻り値仕様）は `docs/requirements/requirements_specification.md` に記録する。

以下は特に守るべきプロジェクト固有ルールです。

- `context` と `ruby_resolver` の挙動:
    - 識別子の解決順は `script 定義` → `context` → `ruby_resolver`
    - `ruby_resolver` は `->(code_or_ident, context_hash)` のシグネチャを想定し、数値を返すこと
    - `context` は呼び出し側が渡す初期環境（ハッシュ）で、数値以外を渡すと `Redex::EvaluationError` を投げる

- 戻り値仕様（評価APIの返却形式）:
    - 最低限 `result`（最終評価値）と `env`（評価後環境ハッシュ）を返す
    - 可能なら `errors`（エラー配列）、`provenance`（識別子の出所）、`meta`（実行時間等）を含める


---

## 禁止事項

- **チケットステータスセクションの編集**: ユーザーのみが更新可能
- **完了チケットの再実装**: `tickets/done/` 内のチケットは対応しない
- **ドキュメント未確認での実装**: 必ず関連ドキュメントを確認してから作業
- **任意の識別子形式の変更**: ULID/UUID の使い分けは厳守

---

## コミュニケーション

### 言語

- **日本語のみ使用**: ユーザーとのやり取りは全て日本語で行う
- コード内コメント、ドキュメントも日本語を基本とする（英語の技術用語は適宜使用可）

### 質問・確認

- 要件が不明確な場合は、作業前に必ず確認
- 複数の解釈が可能な場合は、選択肢を提示して確認
- ドキュメントに記載がない仕様は、推測せずユーザーに確認

